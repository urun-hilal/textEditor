<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Text Editor</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/yaml/yaml.min.js"></script>
</head>
<body>
  <h1>Text Editor</h1>

  <section>
    <h2>Upload File</h2>
    <input type="file" id="fileInput" />
    <button onclick="uploadFile()">Upload</button>
  </section>

  <section>
    <h2>Fetch from Bitbucket</h2>
    <input type="text" id="urlInput" placeholder="Raw file URL" />
    <button onclick="fetchFromBitbucket()">Fetch</button>
  </section>

  <section>
    <h2>Create New File</h2>
    <input type="text" id="newFilename" placeholder="filename.txt" />
    <button onclick="createFile()">Create</button>
  </section>

  <section>
    <h2>Editor</h2>
    <div>Editing: <span id="currentFilename"></span></div>
    <textarea id="editor"></textarea><br />
    <button onclick="saveFile()">Save</button>
  </section>

  <script>
    const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
      lineNumbers: true,
      mode: 'text/plain'
    });

    let currentFile = "";

    function setMode(filename) {
      if (filename.endsWith('.json')) {
        editor.setOption('mode', 'application/json');
      } else if (filename.endsWith('.yaml') || filename.endsWith('.yml')) {
        editor.setOption('mode', 'yaml');
      } else {
        editor.setOption('mode', 'text/plain');
      }
    }

    async function uploadFile() {
      const input = document.getElementById('fileInput');
      const file = input.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('file', file);
      const resp = await fetch('/files/upload', { method: 'POST', body: formData });
      const data = await resp.json();
      currentFile = data.filename;
      document.getElementById('currentFilename').textContent = currentFile;
      await loadContent();
    }

    async function fetchFromBitbucket() {
      const url = document.getElementById('urlInput').value;
      const resp = await fetch('/files/fetch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      const data = await resp.json();
      currentFile = data.filename;
      document.getElementById('currentFilename').textContent = currentFile;
      await loadContent();
    }

    async function createFile() {
      const filename = document.getElementById('newFilename').value;
      if (!filename) return;
      await fetch('/files/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename, content: '' })
      });
      currentFile = filename;
      document.getElementById('currentFilename').textContent = currentFile;
      editor.setValue('');
      setMode(filename);
    }

    async function loadContent() {
      if (!currentFile) return;
      const resp = await fetch('/files/' + encodeURIComponent(currentFile));
      const data = await resp.json();
      editor.setValue(data.content);
      setMode(currentFile);
    }

    async function saveFile() {
      if (!currentFile) return;
      const content = editor.getValue();
      await fetch('/files/' + encodeURIComponent(currentFile), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
      });
      if (confirm('Persist changes to disk?')) {
        await fetch('/files/' + encodeURIComponent(currentFile) + '/save', {
          method: 'POST'
        });
      }
    }
  </script>
</body>
</html>
